<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>IIN Test V6 - COMPLETE</title>
<meta http-equiv="Cache-Control" content="no-cache">
<link rel="stylesheet" href="styles.css">
<link rel="stylesheet" href="calculator.css">
<style>
body::before {
    content: '‚úÖ V6 COMPLETE - With Results!';
    position: fixed; top: 0; width: 100%;
    background: #4caf50; color: white;
    text-align: center; padding: 10px;
    z-index: 9999; font-weight: bold; font-size: 18px;
}
body { padding-top: 40px; }
.mark-review-btn { background: #ff9800 !important; color: white !important; }
.clear-btn { background: #f44336 !important; color: white !important; }
.save-next-btn { background: #4caf50 !important; color: white !important; }
</style>
</head>
<body>

<div id="instructionPage" class="instruction-container">
    <div class="instruction-card">
        <h1>IIN Test V6 - COMPLETE VERSION</h1>
        <input type="text" id="candidateName" value="Test Student">
        <select id="examYear"><option value="2024" selected>2024</option></select>
        <input type="checkbox" id="agreeTerms" checked>
        <button id="beginTestBtn">START TEST</button>
    </div>
</div>

<div id="examInterface" style="display: none;">
    <header class="exam-header">
        <span>IIN Aptitude Test 2024</span>
        <button id="calculatorBtn">üî¢ Calculator</button>
    </header>
    
    <div class="sub-header">
        <button class="section-tab active" data-section="Biology">Biology <span id="biologyCount">0</span></button>
        <button class="section-tab" data-section="Chemistry">Chemistry <span id="chemistryCount">0</span></button>
        <button class="section-tab" data-section="Mathematics">Math <span id="mathematicsCount">0</span></button>
        <button class="section-tab" data-section="Physics">Physics <span id="physicsCount">0</span></button>
        <span id="userName">User</span>
        <span id="timerDisplay">Time: 03:00:00</span>
    </div>
    
    <div class="main-content">
        <div class="question-area">
            <div id="questionNumberDisplay">Question 1</div>
            <div id="questionContent">Loading...</div>
            <div id="optionsContainer"></div>
            
            <div class="question-actions">
                <button class="action-btn mark-review-btn" id="markReviewBtn">Mark for Review & Next</button>
                <button class="action-btn clear-btn" id="clearBtn">Clear Response</button>
                <button class="action-btn save-next-btn" id="saveNextBtn">Save & Next</button>
            </div>
        </div>
        
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="legend-item"><span class="legend-circle answered-circle" id="answeredCount">0</span> Answered</div>
                <div class="legend-item"><span class="legend-circle not-answered-circle" id="notAnsweredCount">0</span> Not Ans</div>
                <div class="legend-item"><span class="legend-circle not-visited-circle" id="notVisitedCount">60</span> Not Visit</div>
                <div class="legend-item"><span class="legend-circle marked-circle" id="markedCount">0</span> Marked</div>
            </div>
            <div id="sectionTitle">Biology</div>
            <div id="questionPalette"></div>
            <button class="submit-exam-btn" id="submitExamBtn">Submit Exam</button>
        </div>
    </div>
</div>

<div id="submitModal" class="modal">
    <div class="modal-content">
        <h2>Confirm Submission</h2>
        <div id="submissionSummary"></div>
        <p style="color: #d32f2f;">‚ö†Ô∏è Once submitted, you cannot change answers!</p>
        <button id="cancelSubmitBtn" class="modal-btn cancel-btn">Cancel</button>
        <button id="confirmSubmitBtn" class="modal-btn confirm-btn">Yes, Submit</button>
    </div>
</div>

<script>
console.log('%c‚úÖ V6 COMPLETE VERSION LOADED', 'background: #4caf50; color: white; font-size: 24px; font-weight: bold');

window.ExamApp = {
    currentSection: 'Biology',
    currentQuestionIndex: 0,
    answers: {},
    markedForReview: {},
    visited: {},
    timeLeft: 10800,
    questionBank: null,
    userName: 'Test Student',
    examYear: '2024'
};

function loadExamData(year) {
    return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = `../js-exam/exam_${year}.js?v=` + Date.now();
        script.onload = () => {
            if (typeof questionBank !== 'undefined') {
                window.ExamApp.questionBank = questionBank;
                console.log('‚úÖ Question bank loaded:', questionBank);
                resolve(questionBank);
            } else {
                reject(new Error('Question bank not found'));
            }
        };
        script.onerror = () => reject(new Error('Failed to load exam'));
        document.body.appendChild(script);
    });
}

async function startExam() {
    console.log('üöÄ Starting exam...');
    try {
        await loadExamData('2024');
        document.getElementById('instructionPage').style.display = 'none';
        document.getElementById('examInterface').style.display = 'block';
        initExam();
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

function initExam() {
    console.log('üéØ Initializing exam...');
    
    // Section tabs
    document.querySelectorAll('.section-tab').forEach(tab => {
        tab.onclick = () => switchSection(tab.getAttribute('data-section'));
    });
    
    // Button listeners
    document.getElementById('markReviewBtn').onclick = (e) => {
        e.preventDefault();
        console.log('üîñ Mark for review clicked');
        markForReviewAndNext();
    };
    
    document.getElementById('clearBtn').onclick = (e) => {
        e.preventDefault();
        console.log('‚ùå Clear clicked');
        clearResponse();
    };
    
    document.getElementById('saveNextBtn').onclick = (e) => {
        e.preventDefault();
        console.log('‚úÖ Save & Next clicked');
        saveAndNext();
    };
    
    document.getElementById('submitExamBtn').onclick = (e) => {
        e.preventDefault();
        console.log('üì§ Submit clicked');
        showSubmitModal();
    };
    
    loadQuestion();
    updateQuestionPalette();
    updateLegendCounts();
    updateSectionCounts();
    
    const qKey = `${window.ExamApp.currentSection}-0`;
    window.ExamApp.visited[qKey] = true;
    
    console.log('‚úÖ Exam initialized');
}

function loadQuestion() {
    console.log('üìñ Loading question', window.ExamApp.currentQuestionIndex);
    if (!window.ExamApp.questionBank) return;
    
    const questions = window.ExamApp.questionBank[window.ExamApp.currentSection];
    const question = questions[window.ExamApp.currentQuestionIndex];
    const qKey = `${window.ExamApp.currentSection}-${window.ExamApp.currentQuestionIndex}`;
    
    window.ExamApp.visited[qKey] = true;
    
    document.getElementById('questionNumberDisplay').textContent = `Question No. ${window.ExamApp.currentQuestionIndex + 1}`;
    document.getElementById('questionContent').innerHTML = `<p class="question-text">${question.text}</p>`;
    
    const container = document.getElementById('optionsContainer');
    container.innerHTML = '';
    
    question.options.forEach((opt, idx) => {
        const btn = document.createElement('button');
        btn.className = 'option-btn';
        btn.innerHTML = `<strong>${String.fromCharCode(65 + idx)}.</strong> ${opt}`;
        
        if (window.ExamApp.answers[qKey] === idx) {
            btn.classList.add('selected');
        }
        
        btn.onclick = () => {
            console.log('‚úîÔ∏è Option', idx, 'selected for question', qKey);
            selectAnswer(idx);
        };
        
        container.appendChild(btn);
    });
    
    document.getElementById('sectionTitle').textContent = window.ExamApp.currentSection;
    updateQuestionPalette();
    updateLegendCounts();
}

function selectAnswer(optIdx) {
    const qKey = `${window.ExamApp.currentSection}-${window.ExamApp.currentQuestionIndex}`;
    window.ExamApp.answers[qKey] = optIdx;
    
    console.log('üíæ Answer saved:', qKey, '=', optIdx);
    console.log('üìä Total answers:', Object.keys(window.ExamApp.answers).length);
    console.log('üìä All answers:', window.ExamApp.answers);
    
    document.querySelectorAll('.option-btn').forEach((btn, i) => {
        if (i === optIdx) {
            btn.classList.add('selected');
        } else {
            btn.classList.remove('selected');
        }
    });
    
    updateQuestionPalette();
    updateLegendCounts();
    updateSectionCounts();
}

function switchSection(section) {
    console.log('üîÑ Switching to:', section);
    window.ExamApp.currentSection = section;
    window.ExamApp.currentQuestionIndex = 0;
    
    document.querySelectorAll('.section-tab').forEach(tab => {
        if (tab.getAttribute('data-section') === section) {
            tab.classList.add('active');
        } else {
            tab.classList.remove('active');
        }
    });
    
    loadQuestion();
}

function markForReviewAndNext() {
    const qKey = `${window.ExamApp.currentSection}-${window.ExamApp.currentQuestionIndex}`;
    window.ExamApp.markedForReview[qKey] = true;
    console.log('‚úÖ Marked for review:', qKey);
    updateQuestionPalette();
    updateLegendCounts();
    saveAndNext();
}

function clearResponse() {
    const qKey = `${window.ExamApp.currentSection}-${window.ExamApp.currentQuestionIndex}`;
    delete window.ExamApp.answers[qKey];
    delete window.ExamApp.markedForReview[qKey];
    console.log('üóëÔ∏è Cleared:', qKey);
    
    document.querySelectorAll('.option-btn').forEach(btn => {
        btn.classList.remove('selected');
    });
    
    updateQuestionPalette();
    updateLegendCounts();
    updateSectionCounts();
}

function saveAndNext() {
    const questions = window.ExamApp.questionBank[window.ExamApp.currentSection];
    
    if (window.ExamApp.currentQuestionIndex < questions.length - 1) {
        window.ExamApp.currentQuestionIndex++;
    } else {
        const sections = ['Biology', 'Chemistry', 'Mathematics', 'Physics'];
        const idx = sections.indexOf(window.ExamApp.currentSection);
        if (idx < sections.length - 1) {
            switchSection(sections[idx + 1]);
            return;
        }
    }
    
    loadQuestion();
}

function updateQuestionPalette() {
    const palette = document.getElementById('questionPalette');
    if (!palette || !window.ExamApp.questionBank) return;
    
    palette.innerHTML = '';
    const questions = window.ExamApp.questionBank[window.ExamApp.currentSection];
    
    questions.forEach((_, idx) => {
        const btn = document.createElement('button');
        btn.className = 'palette-btn';
        btn.textContent = idx + 1;
        
        const qKey = `${window.ExamApp.currentSection}-${idx}`;
        
        if (idx === window.ExamApp.currentQuestionIndex) {
            btn.classList.add('current');
        }
        
        const isAnswered = window.ExamApp.answers[qKey] !== undefined;
        const isMarked = window.ExamApp.markedForReview[qKey];
        const isVisited = window.ExamApp.visited[qKey];
        
        if (isAnswered && isMarked) {
            btn.classList.add('answered-marked');
        } else if (isMarked) {
            btn.classList.add('marked');
        } else if (isAnswered) {
            btn.classList.add('answered');
        } else if (isVisited) {
            btn.classList.add('not-answered');
        } else {
            btn.classList.add('not-visited');
        }
        
        btn.onclick = () => {
            window.ExamApp.currentQuestionIndex = idx;
            loadQuestion();
        };
        
        palette.appendChild(btn);
    });
}

function updateLegendCounts() {
    if (!window.ExamApp.questionBank) return;
    
    let answered = 0, notAnswered = 0, notVisited = 0, marked = 0;
    const sections = ['Biology', 'Chemistry', 'Mathematics', 'Physics'];
    
    sections.forEach(section => {
        const questions = window.ExamApp.questionBank[section];
        questions.forEach((_, idx) => {
            const key = `${section}-${idx}`;
            const isAnswered = window.ExamApp.answers[key] !== undefined;
            const isMarked = window.ExamApp.markedForReview[key];
            const isVisited = window.ExamApp.visited[key];
            
            if (isAnswered && isMarked) {
                // counted in marked
            } else if (isMarked) {
                marked++;
            } else if (isAnswered) {
                answered++;
            } else if (isVisited) {
                notAnswered++;
            } else {
                notVisited++;
            }
        });
    });
    
    const answeredEl = document.getElementById('answeredCount');
    const notAnsweredEl = document.getElementById('notAnsweredCount');
    const notVisitedEl = document.getElementById('notVisitedCount');
    const markedEl = document.getElementById('markedCount');
    
    if (answeredEl) answeredEl.textContent = answered;
    if (notAnsweredEl) notAnsweredEl.textContent = notAnswered;
    if (notVisitedEl) notVisitedEl.textContent = notVisited;
    if (markedEl) markedEl.textContent = marked;
}

function updateSectionCounts() {
    if (!window.ExamApp.questionBank) return;
    
    const sections = ['Biology', 'Chemistry', 'Mathematics', 'Physics'];
    sections.forEach(section => {
        let answered = 0;
        const questions = window.ExamApp.questionBank[section];
        questions.forEach((_, idx) => {
            const key = `${section}-${idx}`;
            if (window.ExamApp.answers[key] !== undefined) {
                answered++;
            }
        });
        const countEl = document.getElementById(`${section.toLowerCase()}Count`);
        if (countEl) countEl.textContent = answered;
    });
}

function showSubmitModal() {
    console.log('üì§ Showing submit confirmation');
    
    let total = 0, answered = 0, notVisited = 0;
    const sections = ['Biology', 'Chemistry', 'Mathematics', 'Physics'];
    
    sections.forEach(section => {
        const questions = window.ExamApp.questionBank[section];
        questions.forEach((_, idx) => {
            total++;
            const key = `${section}-${idx}`;
            if (window.ExamApp.answers[key] !== undefined) {
                answered++;
            }
            if (!window.ExamApp.visited[key]) {
                notVisited++;
            }
        });
    });
    
    const summaryEl = document.getElementById('submissionSummary');
    summaryEl.innerHTML = `
        <p><strong>Total Questions:</strong> ${total}</p>
        <p><strong>Answered:</strong> ${answered}</p>
        <p><strong>Not Answered:</strong> ${total - answered}</p>
        <p><strong>Not Visited:</strong> ${notVisited}</p>
    `;
    
    const modal = document.getElementById('submitModal');
    modal.classList.add('show');
    
    document.getElementById('cancelSubmitBtn').onclick = () => {
        modal.classList.remove('show');
    };
    
    document.getElementById('confirmSubmitBtn').onclick = () => {
        modal.classList.remove('show');
        calculateAndShowResults();
    };
}

function calculateAndShowResults() {
    console.log('üéì Calculating results...');
    console.log('üìä Final answers:', window.ExamApp.answers);
    
    let totalScore = 0, maxScore = 0, totalAttempted = 0, totalCorrect = 0, totalIncorrect = 0;
    const sectionBreakdown = {};
    const sections = ['Biology', 'Chemistry', 'Mathematics', 'Physics'];
    
    sections.forEach(section => {
        const questions = window.ExamApp.questionBank[section];
        const marksPerQ = 4, negMarks = -1;
        
        sectionBreakdown[section] = {
            obtained: 0,
            max: questions.length * marksPerQ,
            attempted: 0,
            correct: 0,
            incorrect: 0,
            total: questions.length
        };
        
        questions.forEach((q, idx) => {
            maxScore += marksPerQ;
            const key = `${section}-${idx}`;
            const answer = window.ExamApp.answers[key];
            
            if (answer !== undefined) {
                totalAttempted++;
                sectionBreakdown[section].attempted++;
                
                if (answer === q.correct) {
                    totalCorrect++;
                    totalScore += marksPerQ;
                    sectionBreakdown[section].obtained += marksPerQ;
                    sectionBreakdown[section].correct++;
                } else {
                    totalIncorrect++;
                    totalScore += negMarks;
                    sectionBreakdown[section].obtained += negMarks;
                    sectionBreakdown[section].incorrect++;
                }
            }
        });
    });
    
    console.log('üìä Results:', {
        totalScore,
        maxScore,
        totalAttempted,
        totalCorrect,
        totalIncorrect,
        sectionBreakdown
    });
    
    showResultsPage({
        totalScore,
        maxScore,
        totalAttempted,
        totalCorrect,
        totalIncorrect,
        sectionBreakdown,
        userName: window.ExamApp.userName,
        examYear: window.ExamApp.examYear,
        timeSpent: 0
    });
}

function showResultsPage(results) {
    const examInterface = document.getElementById('examInterface');
    const percentage = ((results.totalScore / results.maxScore) * 100).toFixed(2);
    
    examInterface.innerHTML = `
        <div style="max-width: 1200px; margin: 30px auto; padding: 30px; background: white;">
            <div style="text-align: center; margin-bottom: 30px;">
                <h1 style="color: #1565c0; font-size: 2.5rem;">üéì Exam Completed!</h1>
                <p style="color: #666;">IIN Aptitude Test ${results.examYear}</p>
                <p><strong>Candidate:</strong> ${results.userName}</p>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px;">
                <div style="background: #1976d2; padding: 20px; border-radius: 8px; text-align: center; color: white;">
                    <div style="font-size: 2rem; font-weight: bold;">${results.totalScore}</div>
                    <div>Total Score (out of ${results.maxScore})</div>
                </div>
                <div style="background: #f57c00; padding: 20px; border-radius: 8px; text-align: center; color: white;">
                    <div style="font-size: 2rem; font-weight: bold;">${percentage}%</div>
                    <div>Percentage</div>
                </div>
                <div style="background: #4caf50; padding: 20px; border-radius: 8px; text-align: center; color: white;">
                    <div style="font-size: 2rem; font-weight: bold;">${results.totalCorrect}</div>
                    <div>Correct (${results.totalAttempted} attempted)</div>
                </div>
                <div style="background: #d32f2f; padding: 20px; border-radius: 8px; text-align: center; color: white;">
                    <div style="font-size: 2rem; font-weight: bold;">${results.totalIncorrect}</div>
                    <div>Incorrect</div>
                </div>
            </div>
            
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
                <thead>
                    <tr style="background: #1565c0; color: white;">
                        <th style="padding: 15px; text-align: left;">Subject</th>
                        <th style="padding: 15px; text-align: center;">Score</th>
                        <th style="padding: 15px; text-align: center;">Max</th>
                        <th style="padding: 15px; text-align: center;">Attempted</th>
                        <th style="padding: 15px; text-align: center;">Correct</th>
                        <th style="padding: 15px; text-align: center;">%</th>
                    </tr>
                </thead>
                <tbody>
                    ${Object.keys(results.sectionBreakdown).map((section, idx) => {
                        const s = results.sectionBreakdown[section];
                        const sectionPercent = ((s.obtained / s.max) * 100).toFixed(1);
                        const bg = idx % 2 === 0 ? '#f5f5f5' : 'white';
                        return `
                            <tr style="background: ${bg};">
                                <td style="padding: 15px;">${section}</td>
                                <td style="padding: 15px; text-align: center; font-weight: bold; color: ${s.obtained >= 0 ? '#4caf50' : '#d32f2f'};">${s.obtained}</td>
                                <td style="padding: 15px; text-align: center;">${s.max}</td>
                                <td style="padding: 15px; text-align: center;">${s.attempted}/${s.total}</td>
                                <td style="padding: 15px; text-align: center; color: #4caf50;">${s.correct}</td>
                                <td style="padding: 15px; text-align: center; font-weight: bold;">${sectionPercent}%</td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
            
            <div style="text-align: center;">
                <button onclick="location.reload()" style="background: #1976d2; color: white; padding: 15px 30px; border: none; border-radius: 5px; font-size: 1.1rem; cursor: pointer;">
                    üîÑ Take Another Exam
                </button>
            </div>
        </div>
    `;
}

// Initialize
document.getElementById('beginTestBtn').onclick = startExam;
console.log('‚úÖ V6 Ready!');
</script>
</body>
</html>