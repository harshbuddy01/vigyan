<!DOCTYPE html>
<html lang="en">
<head>
    <!-- CSS Files (only global for consistency) -->
<link rel="stylesheet" href="css/global.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IIN Assessment Portal - Full Screen Mode</title>
    
    <!-- ACCESS CONTROL: Check if user has purchased tests -->
    <script>
        (function checkAccess() {
            const userEmail = localStorage.getItem("userEmail");
            const purchasedTests = JSON.parse(localStorage.getItem("purchasedTests") || "[]");
            
            // Check if user is logged in and has purchased at least one test
            if (!userEmail || purchasedTests.length === 0) {
                alert("⚠️ Access Denied! Please purchase a test series first.");
                window.location.href = "testfirstpage.html";
                return;
            }
            
            // Optional: Check if user has access to the specific test they're trying to take
            const urlParams = new URLSearchParams(window.location.search);
            const requestedTest = urlParams.get("test") || "iat";
            
            if (!purchasedTests.includes(requestedTest)) {
                alert(`⚠️ You need to purchase ${requestedTest.toUpperCase()} series to access this test.`);
                window.location.href = "testfirstpage.html";
                return;
            }
        })();
    </script>
    
    <script>
      window.MathJax = {
        tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
        svg: { fontCache: 'global' }
      };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        /* --- FULL SCREEN RATIO RESET --- */
        * { box-sizing: border-box; user-select: none; font-family: Arial, Helvetica, sans-serif; }
        body, html { margin: 0; padding: 0; height: 100vh; width: 100vw; background-color: #fff; overflow: hidden; display: flex; flex-direction: column; }

        /* --- HEADER (TCS STYLE) --- */
        .exam-header { height: 40px; background: #2c3e50; color: white; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; font-weight: bold; }
        .sub-header { height: 45px; background: #0088cc; color: white; display: flex; justify-content: space-between; align-items: center; padding: 0 10px; border-bottom: 1px solid #ddd; }
        
        /* --- SECTION TABS --- */
        .sections-tabs { display: flex; height: 100%; align-items: flex-end; }
        .section-tab { 
            background: #006699; color: #fff; border: none; padding: 8px 20px; cursor: pointer; 
            margin-right: 2px; font-size: 0.9rem; border-radius: 5px 5px 0 0; transition: 0.2s; 
        }
        .section-tab.active { background: #fff; color: #333; font-weight: bold; border-top: 4px solid #f39c12; }

        .timer-box { background: #000; color: #fff; padding: 4px 15px; font-size: 1.2rem; font-family: monospace; border-radius: 3px; font-weight: bold; }

        /* --- MAIN CONTENT AREA (75% LEFT, 25% RIGHT) --- */
        .main-container { display: flex; flex: 1; overflow: hidden; }

        /* LEFT SIDE: QUESTION AREA */
        .question-column { flex: 4; display: flex; flex-direction: column; border-right: 1px solid #ccc; position: relative; }
        .q-header-bar { background: #f8f9fa; padding: 10px 20px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; font-weight: bold; font-size: 1rem; }
        
        /* SCROLLABLE CONTENT */
        .q-content-scroll { flex: 1; padding: 40px; overflow-y: auto; font-size: 1.3rem; line-height: 1.5; color: #333; }
        .q-number-box { color: #0088cc; font-size: 1.5rem; font-weight: bold; margin-bottom: 15px; border-bottom: 2px solid #0088cc; display: inline-block; padding-bottom: 5px; }
        
        .option-card { display: flex; align-items: center; gap: 15px; padding: 15px 25px; border: 1px solid #eee; border-radius: 8px; margin-bottom: 15px; cursor: pointer; transition: 0.2s; }
        .option-card:hover { background: #f1f8ff; border-color: #0088cc; }
        .option-card.selected { background: #e3f2fd; border: 2px solid #2196f3; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .option-radio { transform: scale(1.5); }

        /* RIGHT SIDE: SIDEBAR */
        .sidebar { width: 350px; background: #eef2f5; display: flex; flex-direction: column; border-left: 1px solid #ccc; }
        .student-profile { padding: 15px; background: #fff; border-bottom: 1px solid #ddd; display: flex; align-items: center; gap: 10px; }
        .avatar-img { width: 60px; height: 60px; background: #ddd; border-radius: 4px; }
        
        /* STATUS LEGEND (Large Marks) */
        .legend-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 15px; background: #fff; border-bottom: 1px solid #ddd; font-size: 0.85rem; }
        .l-item { display: flex; align-items: center; gap: 8px; }
        .status-shape { width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.8rem; }
        
        /* TCS ICON SHAPES */
        .sh-answered { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><polygon points="0,25 50,0 100,25 100,75 50,100 0,75" fill="%2326a65b"/></svg>'); background-size: cover; }
        .sh-not-answered { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><polygon points="0,25 50,0 100,25 100,75 50,100 0,75" fill="%23c0392b"/></svg>'); background-size: cover; }
        .sh-not-visited { background: #fff; color: #333; border: 1px solid #ccc; border-radius: 2px; }
        .sh-marked { background: #8e44ad; border-radius: 50%; }

        .palette-container { flex: 1; padding: 15px; overflow-y: auto; background: #eef2f5; }
        .palette-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
        .p-btn { width: 50px; height: 45px; background: #fff; border: 1px solid #ccc; cursor: pointer; font-weight: bold; font-size: 1.1rem; display: flex; align-items: center; justify-content: center; }
        
        /* Dynamic Palette Classes */
        .p-answered { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><polygon points="0,25 50,0 100,25 100,75 50,100 0,75" fill="%2326a65b"/></svg>'); color: #fff; border:none; background-size: cover; }
        .p-not-answered { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><polygon points="0,25 50,0 100,25 100,75 50,100 0,75" fill="%23c0392b"/></svg>'); color: #fff; border:none; background-size: cover; }
        .p-marked { background: #8e44ad; color: #fff; border-radius: 50%; border:none; }
        .p-current { border: 3px solid #0000ff !important; box-shadow: 0 0 10px rgba(0,0,255,0.3); }

        /* --- FOOTER ACTION BAR --- */
        .exam-footer { height: 60px; background: #fff; border-top: 1px solid #ccc; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; }
        .btn-left { display: flex; gap: 10px; }
        .footer-btn { padding: 10px 25px; font-weight: bold; cursor: pointer; border-radius: 3px; font-size: 1rem; border: 1px solid #ccc; }
        .save-btn { background: #007bb6; color: white; border: none; padding: 12px 40px; }
        .submit-btn { width: 100%; background: #0088cc; color: white; border: none; padding: 15px; font-weight: bold; cursor: pointer; font-size: 1.1rem; }

        .q-img { max-width: 100%; margin: 20px 0; border: 1px solid #ddd; padding: 10px; box-shadow: 2px 2px 10px rgba(0,0,0,0.05); }
    </style>
</head>
<body>

    <header class="exam-header">
        <div>IIN Aptitude Test Series 2025</div>
        <div style="font-size: 0.8rem;">Version : 17.07.00</div>
    </header>

    <div class="sub-header">
        <div class="sections-tabs">
            <button class="section-tab active" onclick="switchSubject('Physics')">Physics</button>
            <button class="section-tab" onclick="switchSubject('Chemistry')">Chemistry</button>
            <button class="section-tab" onclick="switchSubject('Mathematics')">Mathematics</button>
            <button class="section-tab" onclick="switchSubject('Biology')">Biology</button>
        </div>
        <div class="sub-header-right">
            <span style="font-weight: bold; margin-right:15px;">Time Left:</span>
            <div class="timer-box" id="timerDisplay">03:00:00</div>
        </div>
    </div>

    <div class="main-container">
        <div class="question-column">
            <div class="q-header-bar">
                <span>Question Type : MCQ</span>
                <span>Correct Answer : 4 | Negative Marks : 1</span>
            </div>
            
            <div class="q-content-scroll">
                <div class="q-number-box" id="qNumDisplay">Question No. 1</div>
                <div id="questionText" style="margin-bottom:30px;">Loading question...</div>
                <div id="questionImageContainer"></div>
                
                <div id="optionsContainer">
                    </div>
            </div>

            <div class="exam-footer">
                <div class="btn-left">
                    <button class="footer-btn" onclick="markReview()" style="color:#8e44ad; border-color:#8e44ad;">Mark for Review & Next</button>
                    <button class="footer-btn" onclick="clearResponse()" style="color:#c0392b; border-color:#c0392b;">Clear Response</button>
                </div>
                <button class="footer-btn save-btn" onclick="saveNext()">Save & Next</button>
            </div>
        </div>

        <div class="sidebar">
            <div class="student-profile">
                <div class="avatar-img"></div>
                <div>
                    <div id="userName" style="font-weight: bold; font-size: 1rem; color:#0088cc;">Candidate Name</div>
                    <div style="font-size: 0.8rem; color:#666;">IISER-IAT-2025</div>
                </div>
            </div>

            <div class="legend-grid">
                <div class="l-item"><div class="status-shape sh-answered">0</div> Answered</div>
                <div class="l-item"><div class="status-shape sh-not-answered">0</div> Not Answered</div>
                <div class="l-item"><div class="status-shape sh-not-visited">0</div> Not Visited</div>
                <div class="l-item"><div class="status-shape sh-marked">0</div> Marked for Review</div>
            </div>

            <div style="background:#0088cc; color:white; padding:10px; font-weight:bold; text-align:center;">
                <span id="currentSubjectTitle">Physics</span>
            </div>

            <div class="palette-container">
                <div class="palette-grid" id="questionPalette">
                    </div>
            </div>

            <div style="padding: 10px;">
                <button class="submit-btn" onclick="showSummary()">SUBMIT TEST</button>
            </div>
        </div>
    </div>

    <div id="submitModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:9999; align-items:center; justify-content:center;">
        <div style="background:#fff; width:500px; border-radius:5px; padding:30px; text-align:center;">
            <h2>Test Submission Summary</h2>
            <div id="summaryTable" style="text-align:left; margin:20px 0;"></div>
            <button onclick="finalSubmit()" style="background:#26a65b; color:white; border:none; padding:12px 30px; font-weight:bold; cursor:pointer;">CONFIRM FINAL SUBMIT</button>
            <button onclick="document.getElementById('submitModal').style.display='none'" style="background:#ccc; margin-left:10px; padding:12px 30px; border:none; cursor:pointer;">CANCEL</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        // Use your live Render URL
        const API_BASE_URL = "https://iin-production.up.railway.app";
        
        let questionsBySubject = { "Physics": [], "Chemistry": [], "Mathematics": [], "Biology": [] };
        let currentSubject = "Physics", currentQIndex = 0, userResponses = {}, questionStatus = {};

        window.onload = function() {
            // Retrieve actual user email from local memory
            const email = localStorage.getItem("userEmail");
            if (!email) {
                window.location.href = "signinpage.html";
                return;
            }
            document.getElementById("userName").innerText = email.split('@')[0].toUpperCase();
            
            // Fetch questions from the production server
            fetchQuestions(new URLSearchParams(window.location.search).get("test") || "iat");
            startTimer();
        };

        async function fetchQuestions(testId) {
            try {
                const res = await axios.get(`${API_BASE_URL}/api/get-questions?testId=${testId}`);
                if(res.data.success) {
                    res.data.questions.forEach(q => { 
                        if(questionsBySubject[q.subject]) questionsBySubject[q.subject].push(q); 
                    });
                    switchSubject("Physics");
                }
            } catch(e) { 
                document.getElementById("questionText").innerText = "Connection Error: Server is initializing. Please wait 30s."; 
            }
        }

        // ... Keep your switchSubject, loadQuestion, selectOption functions as they are ...

        async function finalSubmit() {
            const email = localStorage.getItem("userEmail");
            const testId = new URLSearchParams(window.location.search).get("test") || "iat";
            
            try {
                // Post responses to the live MongoDB via Render
                await axios.post(`${API_BASE_URL}/api/submit-exam`, { 
                    email, 
                    testId, 
                    userResponses 
                });
                alert("Test Submitted Successfully. Response sheet will be emailed to you.");
                window.location.href = "testfirstpage.html";
            } catch (error) {
                alert("Submission failed. Checking connection...");
            }
        }

        // Add the timer logic we discussed
        function startTimer() {
            let t = 180 * 60; // 180 minutes
            const timerObj = setInterval(() => {
                t--;
                const h = Math.floor(t/3600).toString().padStart(2,'0');
                const m = Math.floor((t%3600)/60).toString().padStart(2,'0');
                const s = (t%60).toString().padStart(2,'0');
                document.getElementById("timerDisplay").innerText = `${h}:${m}:${s}`;
                
                if(t <= 0) { 
                    clearInterval(timerObj); 
                    finalSubmit(); // Auto-submit when time expires
                }
            }, 1000);
        }
    </script>
    
    <!-- JavaScript Files -->
<script src="js/config.js"></script>
<script src="js/auth.js"></script>
</body>
</html>