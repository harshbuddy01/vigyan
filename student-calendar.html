<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Test Calendar | IIN.edu</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="frontend/css/global.css">
    <link rel="stylesheet" href="frontend/css/navbar.css">
    <link rel="stylesheet" href="frontend/css/user-panel.css">
    <link rel="stylesheet" href="frontend/css/shared-nav-dropdown.css">
    
    <script>
        const API_BASE_URL = "https://iin-production.up.railway.app";
        window.API_BASE_URL = API_BASE_URL;
    </script>
    
    <style>
        :root {
            --blue: #3b82f6;
            --navy-dark: #020617;
            --navy-light: #0f172a;
            --green: #10b981;
            --yellow: #f59e0b;
            --red: #ef4444;
        }
        
        html, body {
            background-color: var(--navy-dark);
            color: #f8fafc;
            font-family: 'Plus Jakarta Sans', sans-serif;
            margin: 0;
            scroll-behavior: smooth;
        }
        
        .grid-bg {
            position: fixed;
            inset: 0;
            background-image: radial-gradient(circle at 2px 2px, rgba(255,255,255,0.03) 1px, transparent 0);
            background-size: 30px 30px;
            z-index: -1;
            pointer-events: none;
        }
        
        .calendar-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 150px 40px 80px;
        }
        
        .page-header {
            text-align: center;
            margin-bottom: 60px;
        }
        
        .page-title {
            font-size: 4rem;
            font-weight: 900;
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: -2px;
        }
        
        .page-subtitle {
            color: #94a3b8;
            font-size: 1.2rem;
            max-width: 600px;
            margin: 0 auto;
        }
        
        /* Filter Pills */
        .filter-pills {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 50px;
            flex-wrap: wrap;
        }
        
        .filter-pill {
            padding: 12px 28px;
            border-radius: 50px;
            background: rgba(15, 23, 42, 0.6);
            border: 2px solid rgba(255, 255, 255, 0.1);
            color: #94a3b8;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .filter-pill:hover {
            border-color: var(--blue);
            color: white;
            background: rgba(59, 130, 246, 0.1);
        }
        
        .filter-pill.active {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border-color: var(--blue);
            color: white;
            box-shadow: 0 0 30px rgba(59, 130, 246, 0.4);
        }
        
        /* Calendar Grid */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 30px;
            margin-bottom: 60px;
        }
        
        .test-card {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            padding: 30px;
            transition: all 0.4s;
            position: relative;
            overflow: hidden;
        }
        
        .test-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--blue), var(--blue));
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .test-card:hover::before {
            opacity: 1;
        }
        
        .test-card:hover {
            transform: translateY(-8px);
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 0 20px 40px -20px rgba(59, 130, 246, 0.3);
        }
        
        .test-badge {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 800;
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-bottom: 16px;
        }
        
        .badge-iat { background: rgba(59, 130, 246, 0.15); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.3); }
        .badge-nest { background: rgba(16, 185, 129, 0.15); color: #34d399; border: 1px solid rgba(16, 185, 129, 0.3); }
        .badge-isi { background: rgba(245, 158, 11, 0.15); color: #fbbf24; border: 1px solid rgba(245, 158, 11, 0.3); }
        
        .test-name {
            font-size: 1.5rem;
            font-weight: 800;
            color: white;
            margin-bottom: 20px;
            line-height: 1.3;
        }
        
        .test-details {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 24px;
        }
        
        .detail-item {
            display: flex;
            align-items: center;
            gap: 12px;
            color: #cbd5e1;
            font-size: 14px;
        }
        
        .detail-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--blue);
        }
        
        .test-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .time-remaining {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #94a3b8;
            font-weight: 600;
        }
        
        .start-btn {
            padding: 12px 28px;
            border-radius: 12px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            font-weight: 800;
            font-size: 14px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .start-btn:hover {
            box-shadow: 0 0 30px rgba(59, 130, 246, 0.6);
            transform: scale(1.05);
        }
        
        .start-btn:disabled {
            background: rgba(100, 116, 139, 0.3);
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: #64748b;
        }
        
        .empty-icon {
            font-size: 80px;
            margin-bottom: 30px;
            opacity: 0.3;
        }
        
        .empty-title {
            font-size: 2rem;
            font-weight: 800;
            color: #94a3b8;
            margin-bottom: 16px;
        }
        
        .empty-text {
            font-size: 1.1rem;
            max-width: 500px;
            margin: 0 auto 30px;
            line-height: 1.6;
        }
        
        .purchase-btn {
            display: inline-block;
            padding: 16px 40px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            font-weight: 800;
            border-radius: 12px;
            text-decoration: none;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }
        
        .purchase-btn:hover {
            box-shadow: 0 0 40px rgba(59, 130, 246, 0.5);
            transform: translateY(-4px);
        }
        
        /* Upcoming indicator */
        .upcoming-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--green);
            box-shadow: 0 0 20px var(--green);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }
        
        /* Loading */
        .loading-spinner {
            text-align: center;
            padding: 80px;
            font-size: 48px;
            color: var(--blue);
        }
        
        @media (max-width: 768px) {
            .calendar-grid {
                grid-template-columns: 1fr;
            }
            
            .page-title {
                font-size: 2.5rem;
            }
            
            .calendar-container {
                padding: 120px 20px 60px;
            }
        }
    </style>
</head>
<body>
    <div class="grid-bg"></div>
    
    <!-- Navbar -->
    <nav class="navbar fixed top-0 w-full z-50 px-12 py-5 flex justify-between items-center bg-[#020617]/90 backdrop-blur-md border-b border-white/5" id="navbar">
        <div class="logo text-2xl font-black text-white cursor-pointer" onclick="window.location.href='index.html'">
            IIN<span class="text-blue-500">.edu</span>
        </div>
        
        <div class="nav-links flex items-center space-x-8 text-sm font-bold text-gray-400">
            <a href="index.html" class="hover:text-white transition">Home</a>
            <a href="aboutpage.html" class="hover:text-white transition">About</a>
            <a href="subtittlepyq.html" class="hover:text-white transition">PYQ</a>
            <a href="testfirstpage.html" class="hover:text-white transition">Tests</a>
            <a href="student-calendar.html" class="text-white transition underline decoration-blue-500 decoration-2 underline-offset-8">My Calendar</a>
            
            <div id="navLoginPlaceholder">
                <a href="signinpage.html" class="btn-login bg-blue-600 px-6 py-2 rounded-full text-white hover:bg-blue-700 transition shadow-lg shadow-blue-900/40">
                    Login
                </a>
            </div>
        </div>
    </nav>
    
    <div class="calendar-container">
        <!-- Header -->
        <div class="page-header">
            <h1 class="page-title">
                <i class="fas fa-calendar-alt"></i> My Test Calendar
            </h1>
            <p class="page-subtitle">
                View all your upcoming tests and stay prepared. Only tests from your purchased series are shown.
            </p>
        </div>
        
        <!-- Filter Pills -->
        <div class="filter-pills" id="filterPills">
            <button class="filter-pill active" data-filter="all">
                <i class="fas fa-th"></i> All Tests
            </button>
        </div>
        
        <!-- Calendar Grid -->
        <div id="calendarContent">
            <div class="loading-spinner">
                <i class="fas fa-spinner fa-spin"></i>
            </div>
        </div>
    </div>
    
    <script src="frontend/js/config.js"></script>
    <script src="frontend/js/auth.js"></script>
    <script src="frontend/js/user-panel.js"></script>
    
    <script>
        // Get user's purchased tests
        const purchasedTests = JSON.parse(localStorage.getItem('purchasedTests') || '[]');
        const userEmail = localStorage.getItem('userEmail');
        const userRoll = localStorage.getItem('userRollNumber');
        
        console.log('ðŸ“… User purchased tests:', purchasedTests);
        
        let allScheduledTests = [];
        let currentFilter = 'all';
        
        // Initialize
        async function init() {
            // Render user panel
            if (window.refreshUserDashboard) window.refreshUserDashboard();
            
            // Check if user has purchased any tests
            if (purchasedTests.length === 0) {
                showEmptyState();
                return;
            }
            
            // Render filter pills for purchased series
            renderFilterPills();
            
            // Load scheduled tests from backend
            await loadScheduledTests();
        }
        
        function renderFilterPills() {
            const pillsContainer = document.getElementById('filterPills');
            let html = '<button class="filter-pill active" data-filter="all" onclick="filterTests(\'all\')">' +
                       '<i class="fas fa-th"></i> All Tests</button>';
            
            // Add pills for each purchased series
            purchasedTests.forEach(testId => {
                const testName = testId.toUpperCase();
                html += `<button class="filter-pill" data-filter="${testId}" onclick="filterTests('${testId}')">
                    <i class="fas fa-flask"></i> ${testName} Only
                </button>`;
            });
            
            pillsContainer.innerHTML = html;
        }
        
        async function loadScheduledTests() {
            try {
                console.log('ðŸ”„ Loading scheduled tests from backend...');
                const response = await fetch(`${API_BASE_URL}/api/admin/tests`);
                const data = await response.json();
                
                allScheduledTests = data.tests || [];
                console.log(`âœ… Loaded ${allScheduledTests.length} total tests`);
                
                // Filter to show only tests from purchased series
                const myTests = allScheduledTests.filter(test => {
                    const testSeries = test.test_id || test.testId || '';
                    const matched = purchasedTests.some(pt => testSeries.toLowerCase().includes(pt.toLowerCase()));
                    console.log(`Test: ${test.test_name}, Series: ${testSeries}, Matched: ${matched}`);
                    return matched;
                });
                
                console.log(`ðŸŽ¯ Filtered to ${myTests.length} tests for user`);
                
                if (myTests.length === 0) {
                    showNoTestsScheduled();
                } else {
                    renderCalendar(myTests);
                }
            } catch (error) {
                console.error('âŒ Error loading tests:', error);
                showError();
            }
        }
        
        function filterTests(filter) {
            currentFilter = filter;
            
            // Update active pill
            document.querySelectorAll('.filter-pill').forEach(pill => {
                pill.classList.remove('active');
                if (pill.dataset.filter === filter) {
                    pill.classList.add('active');
                }
            });
            
            // Filter and render
            const myTests = allScheduledTests.filter(test => {
                const testSeries = test.test_id || test.testId || '';
                const matchesPurchased = purchasedTests.some(pt => testSeries.toLowerCase().includes(pt.toLowerCase()));
                
                if (filter === 'all') return matchesPurchased;
                return matchesPurchased && testSeries.toLowerCase().includes(filter.toLowerCase());
            });
            
            renderCalendar(myTests);
        }
        
        function renderCalendar(tests) {
            const content = document.getElementById('calendarContent');
            
            if (tests.length === 0) {
                content.innerHTML = '<div class="empty-state">' +
                    '<div class="empty-icon"><i class="fas fa-calendar-times"></i></div>' +
                    '<h2 class="empty-title">No Tests Found</h2>' +
                    '<p class="empty-text">No tests match your current filter. Try selecting "All Tests" above.</p>' +
                    '</div>';
                return;
            }
            
            let html = '<div class="calendar-grid">';
            
            tests.forEach(test => {
                const testSeries = (test.test_id || test.testId || '').toLowerCase();
                const badgeClass = `badge-${testSeries}`;
                const examDate = test.exam_date || test.examDate || 'TBA';
                const duration = test.duration || test.test_duration || 'N/A';
                const totalQuestions = test.total_questions || 'N/A';
                
                // Calculate days remaining
                const daysRemaining = calculateDaysRemaining(examDate);
                const isUpcoming = daysRemaining >= 0 && daysRemaining <= 7;
                
                html += `
                    <div class="test-card">
                        ${isUpcoming ? '<div class="upcoming-indicator"></div>' : ''}
                        
                        <span class="test-badge ${badgeClass}">${testSeries.toUpperCase()}</span>
                        
                        <h3 class="test-name">${test.test_name}</h3>
                        
                        <div class="test-details">
                            <div class="detail-item">
                                <div class="detail-icon"><i class="fas fa-calendar"></i></div>
                                <div>
                                    <div style="font-size: 12px; color: #64748b; text-transform: uppercase; font-weight: 700;">Exam Date</div>
                                    <div style="font-weight: 700; color: white;">${formatDate(examDate)}</div>
                                </div>
                            </div>
                            
                            <div class="detail-item">
                                <div class="detail-icon"><i class="fas fa-clock"></i></div>
                                <div>
                                    <div style="font-size: 12px; color: #64748b; text-transform: uppercase; font-weight: 700;">Duration</div>
                                    <div style="font-weight: 700; color: white;">${duration} minutes</div>
                                </div>
                            </div>
                            
                            <div class="detail-item">
                                <div class="detail-icon"><i class="fas fa-question-circle"></i></div>
                                <div>
                                    <div style="font-size: 12px; color: #64748b; text-transform: uppercase; font-weight: 700;">Questions</div>
                                    <div style="font-weight: 700; color: white;">${totalQuestions} questions</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="test-footer">
                            <div class="time-remaining">
                                <i class="fas fa-hourglass-half"></i>
                                ${getDaysRemainingText(daysRemaining)}
                            </div>
                            <button class="start-btn" onclick="startTest('${test.test_id || test.testId}')">
                                <i class="fas fa-play"></i> Start Test
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            content.innerHTML = html;
        }
        
        function calculateDaysRemaining(examDate) {
            if (!examDate || examDate === 'TBA') return 999;
            const exam = new Date(examDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            exam.setHours(0, 0, 0, 0);
            const diff = exam - today;
            return Math.ceil(diff / (1000 * 60 * 60 * 24));
        }
        
        function getDaysRemainingText(days) {
            if (days < 0) return '<span style="color: #ef4444;">Exam Passed</span>';
            if (days === 0) return '<span style="color: #f59e0b; font-weight: 800;">TODAY!</span>';
            if (days === 1) return '<span style="color: #f59e0b;">Tomorrow</span>';
            if (days <= 7) return `<span style="color: #10b981;">${days} days remaining</span>`;
            return `${days} days remaining`;
        }
        
        function formatDate(dateStr) {
            if (!dateStr || dateStr === 'TBA') return 'To Be Announced';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-IN', { 
                weekday: 'short', 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }
        
        function startTest(testId) {
            localStorage.setItem('currentTestId', testId);
            window.location.href = 'instructions.html?test=' + testId;
        }
        
        function showEmptyState() {
            document.getElementById('calendarContent').innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon"><i class="fas fa-shopping-cart"></i></div>
                    <h2 class="empty-title">No Test Series Purchased</h2>
                    <p class="empty-text">
                        You haven't purchased any test series yet. Get started by purchasing a test series to see your personalized calendar.
                    </p>
                    <a href="testfirstpage.html" class="purchase-btn">
                        <i class="fas fa-shopping-bag"></i> Browse Test Series
                    </a>
                </div>
            `;
        }
        
        function showNoTestsScheduled() {
            document.getElementById('calendarContent').innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon"><i class="fas fa-calendar-plus"></i></div>
                    <h2 class="empty-title">No Tests Scheduled Yet</h2>
                    <p class="empty-text">
                        Your admin hasn't scheduled any tests for your purchased series yet. Check back soon!
                    </p>
                </div>
            `;
        }
        
        function showError() {
            document.getElementById('calendarContent').innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon" style="color: #ef4444;"><i class="fas fa-exclamation-triangle"></i></div>
                    <h2 class="empty-title">Connection Error</h2>
                    <p class="empty-text">
                        Failed to load test schedule. Please check your internet connection and try again.
                    </p>
                    <button onclick="location.reload()" class="purchase-btn" style="background: #ef4444;">
                        <i class="fas fa-sync"></i> Retry
                    </button>
                </div>
            `;
        }
        
        // Initialize on load
        window.onload = init;
    </script>
</body>
</html>